<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Capacit√© 05h00 - Analyse D√©taill√©e</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .agent-card {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
        }
        .active { background-color: #d4edda; }
        .inactive { background-color: #f8d7da; }
        .chef { background-color: #fff3cd; }
        .pause { background-color: #e2e3e5; }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Capacit√© 05h00 - Analyse D√©taill√©e</h1>
        <p>Analyse compl√®te du calcul de capacit√© √† 05:00:00 pour la p√©riode Semaine Charg√©e</p>
        
        <div id="debug-output"></div>
    </div>

    <!-- Include all necessary scripts -->
    <script src="vacationGrids.js?v=<?php echo time(); ?>"></script>
    <script src="staffingMap.js"></script>
    <script src="sivRules.js"></script>
    <script src="CapacityCalculator.js"></script>

    <script>
        function debugCapacityAt05h() {
            const output = document.getElementById('debug-output');
            let html = '';

            try {
                // 1. V√©rifier que tous les composants sont charg√©s
                html += '<div class="debug-section">';
                html += '<h3>1. V√©rification des Composants</h3>';
                html += `<p>VacationGrids charg√©: ${typeof vacationGrids !== 'undefined' ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>StaffingMap charg√©: ${typeof staffingMap !== 'undefined' ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>SivRules charg√©: ${typeof sivRules !== 'undefined' ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>CapacityCalculator charg√©: ${typeof CapacityCalculator !== 'undefined' ? '‚úÖ' : '‚ùå'}</p>`;
                html += '</div>';

                // 2. Initialiser le calculateur
                const calculator = new CapacityCalculator(staffingMap, sivRules, vacationGrids);
                
                // 3. Analyser la grille SemCha
                html += '<div class="debug-section">';
                html += '<h3>2. Analyse de la Grille SemCha</h3>';
                
                const grid = vacationGrids.Sem?.Cha;
                if (!grid) {
                    html += '<p class="error">‚ùå Grille SemCha non trouv√©e!</p>';
                } else {
                    html += `<p class="success">‚úÖ Grille SemCha trouv√©e avec ${grid.grid.length} agents</p>`;
                    
                    // Analyser les agents par type
                    const agentsByType = calculator.getAgentsByType(grid);
                    html += '<h4>Agents par type:</h4>';
                    html += `<p>Je: ${agentsByType.Je.length} agents</p>`;
                    html += `<p>M: ${agentsByType.M.length} agents</p>`;
                    html += `<p>J: ${agentsByType.J.length} agents</p>`;
                    html += `<p>SN: ${agentsByType.SN.length} agents</p>`;
                }
                html += '</div>';

                // 4. S√©lection des agents
                html += '<div class="debug-section">';
                html += '<h3>3. S√©lection des Agents (3 Je + 8 M + 8 J + 8 SN)</h3>';
                
                const selectedAgents = calculator.selectAgentProfiles(grid);
                html += `<p>Nombre d'agents s√©lectionn√©s: ${Object.keys(selectedAgents).length}</p>`;
                
                // Afficher les agents s√©lectionn√©s
                html += '<div class="agent-grid">';
                for (const [index, agent] of Object.entries(selectedAgents)) {
                    const status05h = agent['05:00:00'];
                    const statusClass = status05h === '1' ? 'active' : 
                                       status05h === '0' ? 'inactive' : 
                                       status05h === 'C' ? 'chef' : 'pause';
                    
                    html += `<div class="agent-card ${statusClass}">`;
                    html += `<strong>${agent.vacation}</strong><br>`;
                    html += `05:00:00 = "${status05h}"<br>`;
                    html += `Type: ${agent.vacation.startsWith('Je') ? 'Je' : 
                                   agent.vacation.startsWith('M') ? 'M' : 
                                   agent.vacation.startsWith('J') ? 'J' : 'SN'}`;
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';

                // 5. Calcul des agents actifs √† 05:00:00
                html += '<div class="debug-section">';
                html += '<h3>4. Calcul des Agents Actifs √† 05:00:00</h3>';
                
                const activeAgentsAt05h = calculator.countActiveAgents(selectedAgents, '05:00:00');
                html += `<p class="success">Agents actifs (valeur "1") √† 05:00:00: <strong>${activeAgentsAt05h}</strong></p>`;
                
                // D√©tail par type
                let jeActive = 0, mActive = 0, jActive = 0, snActive = 0;
                for (const agent of Object.values(selectedAgents)) {
                    if (agent['05:00:00'] === '1') {
                        if (agent.vacation.startsWith('Je')) jeActive++;
                        else if (agent.vacation.startsWith('M')) mActive++;
                        else if (agent.vacation.startsWith('J')) jActive++;
                        else snActive++;
                    }
                }
                html += `<p>D√©tail: Je=${jeActive}, M=${mActive}, J=${jActive}, SN=${snActive}</p>`;
                html += '</div>';

                // 6. R√©duction SIV
                html += '<div class="debug-section">';
                html += '<h3>5. R√©duction SIV</h3>';
                
                const timestamp = new Date();
                timestamp.setHours(5, 0, 0, 0);
                
                const sivReduction = calculator.getSIVReduction('Cha', 'Sem', timestamp, 'VFR fort');
                html += `<p>R√©duction SIV √† 05h00 (p√©riode charg√©e, semaine, VFR fort): <strong>${sivReduction}</strong></p>`;
                
                const effectiveAgents = Math.max(0, activeAgentsAt05h - sivReduction);
                html += `<p class="success">Agents effectifs: ${activeAgentsAt05h} - ${sivReduction} = <strong>${effectiveAgents}</strong></p>`;
                html += '</div>';

                // 7. Mapping vers capacit√©
                html += '<div class="debug-section">';
                html += '<h3>6. Mapping vers Capacit√©</h3>';
                
                const capacity = calculator.staffingLookup(effectiveAgents);
                html += `<p class="success">Capacit√© pour ${effectiveAgents} agents effectifs: <strong>${capacity}</strong></p>`;
                
                // Afficher le mapping staffing pour r√©f√©rence
                html += '<h4>Mapping StaffingMap (extrait):</h4>';
                html += '<table>';
                html += '<tr><th>Agents</th><th>Capacit√©</th></tr>';
                for (let i = Math.max(0, effectiveAgents - 3); i <= effectiveAgents + 3; i++) {
                    if (staffingMap[i] !== undefined) {
                        const highlight = i === effectiveAgents ? 'style="background-color: #ffffcc;"' : '';
                        html += `<tr ${highlight}><td>${i}</td><td>${staffingMap[i]}</td></tr>`;
                    }
                }
                html += '</table>';
                html += '</div>';

                // 8. R√©sum√© final
                html += '<div class="debug-section">';
                html += '<h3>7. R√©sum√© Final</h3>';
                html += `<p><strong>Heure analys√©e:</strong> 05:00:00</p>`;
                html += `<p><strong>Grille:</strong> SemCha (Semaine Charg√©e)</p>`;
                html += `<p><strong>Agents s√©lectionn√©s:</strong> ${Object.keys(selectedAgents).length}</p>`;
                html += `<p><strong>Agents actifs:</strong> ${activeAgentsAt05h}</p>`;
                html += `<p><strong>R√©duction SIV:</strong> ${sivReduction}</p>`;
                html += `<p><strong>Agents effectifs:</strong> ${effectiveAgents}</p>`;
                html += `<p><strong>Capacit√© finale:</strong> <span class="${capacity === 0 ? 'error' : 'success'}">${capacity}</span></p>`;
                
                if (capacity === 0) {
                    html += '<p class="error">‚ö†Ô∏è PROBL√àME: La capacit√© est nulle!</p>';
                    if (effectiveAgents === 0) {
                        html += '<p class="warning">Cause probable: Aucun agent effectif (tous inactifs ou r√©duction SIV trop importante)</p>';
                    }
                } else if (capacity !== 22) {
                    html += `<p class="warning">‚ö†Ô∏è ATTENTION: Capacit√© attendue = 22, obtenue = ${capacity}</p>`;
                } else {
                    html += '<p class="success">‚úÖ Capacit√© correcte!</p>';
                }
                html += '</div>';

            } catch (error) {
                html += `<div class="debug-section"><h3>Erreur</h3><p class="error">Erreur lors du debug: ${error.message}</p></div>`;
                console.error('Erreur debug:', error);
            }

            output.innerHTML = html;
        }

        // Lancer le debug au chargement de la page
        window.addEventListener('load', () => {
            setTimeout(debugCapacityAt05h, 100);
        });
    </script>
</body>
</html>
